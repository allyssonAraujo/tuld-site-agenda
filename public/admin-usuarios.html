<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rio de Usu√°rios - T.U.L.D. Admin</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        @media print {
            .no-print { display: none; }
            .navbar, .card-header, button { display: none !important; }
            body { background: white; }
        }
        
        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .user-table th, .user-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .user-table th {
            background-color: #f5f5f5;
            font-weight: bold;
        }
        
        .user-table tr:hover {
            background-color: #f9f9f9;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: bold;
        }
        
        .status-ativo {
            background-color: #4caf50;
            color: white;
        }
        
        .status-bloqueado {
            background-color: #f44336;
            color: white;
        }
        
        .stat-badge {
            display: inline-block;
            margin-right: 8px;
            padding: 3px 8px;
            background-color: #e0e0e0;
            border-radius: 3px;
            font-size: 0.85rem;
        }
        
        .filter-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navbar -->
    <nav class="navbar no-print">
        <div class="container">
            <div class="navbar-brand">
                <img src="/img/logremov.jpg" alt="Logo Terreiro" style="height:56px;vertical-align:middle;margin-right:10px;"> <h1 style="display:inline-block;vertical-align:middle;">T.U.L.D. - Admin</h1>
            </div>
            <div class="navbar-menu">
                <a href="/admin-eventos.html" class="nav-link">‚Üê Voltar a Eventos</a>
                <button id="btnSair" class="btn btn-secondary">Sair</button>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <!-- Header -->
            <section class="card mb-4 terreiro">
                <div class="barra-verde" aria-hidden="true"></div>
                <div class="card-content">
                    <h2>üìä Relat√≥rio de Usu√°rios</h2>
                    <p class="text-muted">Lista completa de usu√°rios com hist√≥rico de agendamentos. Voc√™ pode imprimir ou exportar em CSV.</p>
                </div>
            </section>

            <!-- Filtros e A√ß√µes -->
            <section class="card mb-4 no-print terreiro">
                <div class="barra-verde" aria-hidden="true"></div>
                <div class="filter-section">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                        <label for="filterStatus" style="margin-bottom: 0;">
                            Filtrar por status:
                            <select id="filterStatus" style="padding: 8px 12px; border-radius: 4px; border: 1px solid #ccc;">
                                <option value="">Todos</option>
                                <option value="ativo">Ativo</option>
                                <option value="bloqueado">Bloqueado</option>
                            </select>
                        </label>
                        
                        <label for="filterEventoPresence" style="margin-bottom: 0; margin-left: auto;">
                            Evento:
                            <select id="filterEventoPresence" style="padding: 8px 12px; border-radius: 4px; border: 1px solid #ccc;">
                                <option value="">Todos eventos</option>
                            </select>
                        </label>
                        <button id="btnDownloadPresencePDF" class="btn btn-primary">
                            üì• Baixar Lista de Presen√ßa (PDF)
                        </button>
                        <button onclick="window.print()" class="btn btn-primary">
                            üñ®Ô∏è Imprimir
                        </button>
                    </div>
                </div>

                <!-- Estat√≠sticas Resumidas -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 15px 0;">
                    <div style="text-align: center; padding: 10px; background: #e3f2fd; border-radius: 4px;">
                        <p style="margin: 0; font-size: 1.5rem; font-weight: bold; color: #d22219;" id="totalUsers">0</p>
                        <p style="margin: 5px 0 0 0; color: #555;">Total de Usu√°rios</p>
                    </div>
                    <div style="text-align: center; padding: 10px; background: #e8f5e9; border-radius: 4px;">
                        <p style="margin: 0; font-size: 1.5rem; font-weight: bold; color: #388e3c;" id="totalAtivos">0</p>
                        <p style="margin: 5px 0 0 0; color: #555;">Usu√°rios Ativos</p>
                    </div>
                    <div style="text-align: center; padding: 10px; background: #ffebee; border-radius: 4px;">
                        <p style="margin: 0; font-size: 1.5rem; font-weight: bold; color: #d32f2f;" id="totalBloqueados">0</p>
                        <p style="margin: 5px 0 0 0; color: #555;">Bloqueados</p>
                    </div>
                    <div style="text-align: center; padding: 10px; background: #fff3e0; border-radius: 4px;">
                        <p style="margin: 0; font-size: 1.5rem; font-weight: bold; color: #f57c00;" id="totalAgendamentos">0</p>
                        <p style="margin: 5px 0 0 0; color: #555;">Total Agendamentos</p>
                    </div>
                </div>
            </section>

            <!-- Abas: Usu√°rios e Presen√ßa -->
            <section class="card mb-4 no-print terreiro">
                <div class="barra-verde" aria-hidden="true"></div>
                <div class="card-content" style="padding-bottom: 1rem;">
                    <div class="profile-tabs" style="margin-bottom: 0;">
                        <button class="profile-tab-btn active" data-tab="usuarios">üë• Usu√°rios</button>
                        <button class="profile-tab-btn" data-tab="presenca">üßæ Presen√ßa</button>
                    </div>
                </div>
            </section>

            <!-- Tabela de Usu√°rios -->
            <section class="card terreiro profile-tab-content active" data-content="usuarios">
                <div class="barra-verde" aria-hidden="true"></div>
                <div class="card-content">
                    <div style="overflow-x: auto;">
                        <table class="user-table" id="usersTable">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Email</th>
                                    <th>Telefone</th>
                                    <th>Status</th>
                                    <th>Data Cadastro</th>
                                    <th style="text-align: center;">Agendamentos</th>
                                    <th style="text-align: center;">Presen√ßas</th>
                                    <th style="text-align: center;">Aus√™ncias</th>
                                    <th style="text-align: center;">Confirmados</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr>
                                    <td colspan="9" style="text-align: center; padding: 30px;">Carregando usu√°rios...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="nenhunUsuario" class="alert alert-info" style="display: none; text-align: center; margin-top: 20px;">
                        Nenhum usu√°rio encontrado com os filtros aplicados.
                    </div>
                </div>
            </section>

            <!-- Lista de Presen√ßa na Tela -->
            <section class="card terreiro mt-4 profile-tab-content" data-content="presenca">
                <div class="barra-verde" aria-hidden="true"></div>
                <div class="card-content">
                    <h3>üßæ Lista de Presen√ßa (Visualiza√ß√£o)</h3>
                    <p class="text-muted">Exibe os registros com justificativa de cancelamento quando houver.</p>

                    <div style="overflow-x: auto; margin-top: 12px;">
                        <table class="user-table" id="presenceTable">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>T√≠tulo do Evento</th>
                                    <th>Data do Evento</th>
                                    <th>Senha</th>
                                    <th>Justificativa</th>
                                </tr>
                            </thead>
                            <tbody id="presenceTableBody">
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 20px;">Carregando lista...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="nenhumaPresenca" class="alert alert-info" style="display: none; text-align: center; margin-top: 20px;">
                        Nenhum registro de presen√ßa encontrado para o filtro selecionado.
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script src="/js/api.js"></script>
    <!-- jsPDF + autoTable (CDN) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script>
        let usuariosData = [];
        let presencasData = [];

        function toInt(value) {
            const parsed = Number.parseInt(value, 10);
            return Number.isNaN(parsed) ? 0 : parsed;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const isAdmin = await verificarAcessoAdmin();
            if (!isAdmin) return;

            configurarAbasRelatorio();
            carregarUsuarios();
            document.getElementById('btnSair').addEventListener('click', sair);
            document.getElementById('btnDownloadPresencePDF').addEventListener('click', downloadPresencePDF);
            document.getElementById('filterStatus').addEventListener('change', filtrarUsuarios);
            populateEventoSelect();
            carregarListaPresenca();
        });

        function configurarAbasRelatorio() {
            const tabButtons = document.querySelectorAll('.profile-tab-btn[data-tab]');
            const contents = document.querySelectorAll('.profile-tab-content[data-content]');

            tabButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.dataset.tab;

                    tabButtons.forEach(b => b.classList.remove('active'));
                    contents.forEach(c => c.classList.remove('active'));

                    btn.classList.add('active');
                    const section = document.querySelector(`.profile-tab-content[data-content="${tab}"]`);
                    if (section) section.classList.add('active');
                });
            });
        }

        async function verificarAcessoAdmin() {
            try {
                const res = await fetch('/api/usuario', { credentials: 'same-origin' });
                if (!res.ok) {
                    window.location.href = '/index.html';
                    return false;
                }

                const usuario = await res.json();
                if (!usuario || usuario.id !== 1) {
                    mostrarMensagem('Acesso permitido apenas para administrador.', 'error');
                    setTimeout(() => {
                        window.location.href = '/dashboard.html';
                    }, 1200);
                    return false;
                }

                return true;
            } catch (error) {
                window.location.href = '/index.html';
                return false;
            }
        }

        async function carregarUsuarios() {
            try {
                const res = await fetch('/api/admin/relatorio/usuarios');
                if (!res.ok) throw new Error('Erro ao carregar usu√°rios');
                
                const data = await res.json();
                usuariosData = data.usuarios || [];
                
                renderizarTabela(usuariosData);
                atualizarEstatisticas(usuariosData);
                
            } catch (error) {
                console.error('Erro:', error);
                mostrarMensagem('Erro ao carregar usu√°rios', 'error');
            }
        }

        function renderizarTabela(usuarios) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            if (usuarios.length === 0) {
                document.getElementById('nenhunUsuario').style.display = 'block';
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">Nenhum usu√°rio encontrado.</td></tr>';
                return;
            }

            document.getElementById('nenhunUsuario').style.display = 'none';

            usuarios.forEach(user => {
                const dataCadastro = new Date(user.data_cadastro);
                const statusClass = user.status === 'ativo' ? 'status-ativo' : 'status-bloqueado';
                const statusText = user.status === 'ativo' ? '‚úÖ Ativo' : '‚ùå Bloqueado';
                const totalAgendamentos = toInt(user.total_agendamentos);
                const presencas = toInt(user.presencas);
                const ausencias = toInt(user.ausencias);
                const confirmados = toInt(user.confirmados);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${user.nome}</strong></td>
                    <td>${user.email}</td>
                    <td>${user.telefone || '-'}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>${dataCadastro.toLocaleDateString('pt-BR')}</td>
                    <td style="text-align: center;"><strong>${totalAgendamentos}</strong></td>
                    <td style="text-align: center; color: #4caf50;"><strong>${presencas}</strong></td>
                    <td style="text-align: center; color: #f44336;"><strong>${ausencias}</strong></td>
                    <td style="text-align: center;"><strong>${confirmados}</strong></td>
                `;
                tbody.appendChild(row);
            });
        }

        function atualizarEstatisticas(usuarios) {
            const total = usuarios.length;
            const ativos = usuarios.filter(u => u.status === 'ativo').length;
            const bloqueados = usuarios.filter(u => u.status === 'bloqueado').length;
            const totalAgendamentos = usuarios.reduce((sum, u) => sum + toInt(u.total_agendamentos), 0);

            document.getElementById('totalUsers').textContent = total;
            document.getElementById('totalAtivos').textContent = ativos;
            document.getElementById('totalBloqueados').textContent = bloqueados;
            document.getElementById('totalAgendamentos').textContent = totalAgendamentos;
        }

        function filtrarUsuarios() {
            const statusFilter = document.getElementById('filterStatus').value;
            let filtrados = usuariosData;

            if (statusFilter) {
                filtrados = usuariosData.filter(u => u.status === statusFilter);
            }

            renderizarTabela(filtrados);
            atualizarEstatisticas(filtrados);
        }

        function downloadCSV() {
            if (usuariosData.length === 0) {
                mostrarMensagem('Nenhum usu√°rio para exportar', 'info');
                return;
            }

            const headers = ['Nome', 'Email', 'Telefone', 'Status', 'Data Cadastro', 'Total Agendamentos', 'Presen√ßas', 'Aus√™ncias', 'Confirmados'];
            const rows = usuariosData.map(u => [
                u.nome,
                u.email,
                u.telefone || '',
                u.status,
                new Date(u.data_cadastro).toLocaleDateString('pt-BR'),
                toInt(u.total_agendamentos),
                toInt(u.presencas),
                toInt(u.ausencias),
                toInt(u.confirmados)
            ]);

            const csv = [];
            csv.push(headers.map(h => `"${h}"`).join(','));
            rows.forEach(row => {
                csv.push(row.map(cell => `"${(cell || '').toString().replace(/"/g, '""')}"`).join(','));
            });

            const blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `relatorio_usuarios_${Date.now()}.csv`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);

            mostrarMensagem('Relat√≥rio exportado com sucesso!', 'success');
        }

        // formata data ISO para dd/mm/aaaa
        function formatDate(iso) {
            try {
                const d = new Date(iso);
                return d.toLocaleDateString('pt-BR');
            } catch (e) {
                return iso;
            }
        }

        async function populateEventoSelect() {
            try {
                const res = await fetch('/api/dashboard/eventos', { credentials: 'same-origin' });
                if (!res.ok) throw new Error('Falha ao obter eventos');
                const data = await res.json();
                const eventos = data.eventos || [];
                const sel = document.getElementById('filterEventoPresence');
                sel.innerHTML = '';
                // Adiciona op√ß√£o "Todos" como default
                const optTodos = document.createElement('option');
                optTodos.value = '';
                optTodos.textContent = 'Todos';
                sel.appendChild(optTodos);
                eventos.forEach(ev => {
                    const opt = document.createElement('option');
                    opt.value = ev.id;
                    opt.textContent = `${ev.titulo} (${formatDate(ev.data_evento)})`;
                    opt.dataset.title = ev.titulo;
                    sel.appendChild(opt);
                });
                sel.value = '';
                sel.addEventListener('change', carregarListaPresenca);
            } catch (err) {
                console.error('Erro ao popular eventos:', err);
            }
        }

        async function carregarListaPresenca() {
            try {
                const eventoId = document.getElementById('filterEventoPresence').value;
                const url = eventoId
                    ? `/api/admin/relatorio/presencas?evento_id=${encodeURIComponent(eventoId)}`
                    : '/api/admin/relatorio/presencas';

                const res = await fetch(url, { credentials: 'same-origin' });
                if (!res.ok) throw new Error('Falha ao carregar lista de presen√ßa');

                const data = await res.json();
                presencasData = data.presencas || [];
                renderizarListaPresenca(presencasData);
            } catch (err) {
                console.error('Erro ao carregar lista de presen√ßa:', err);
                mostrarMensagem('Erro ao carregar lista de presen√ßa', 'error');
            }
        }

        function renderizarListaPresenca(rows) {
            const tbody = document.getElementById('presenceTableBody');
            const empty = document.getElementById('nenhumaPresenca');
            tbody.innerHTML = '';

            if (!rows.length) {
                empty.style.display = 'block';
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">Nenhum registro encontrado.</td></tr>';
                return;
            }

            empty.style.display = 'none';

            rows.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${r.nome || '-'}</td>
                    <td>${r.titulo_evento || '-'}</td>
                    <td>${formatDate(r.data_evento)}</td>
                    <td>${(r.senha ?? '-')}</td>
                    <td>${r.justificativa || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function downloadPresenceCSV() {
            const eventoId = document.getElementById('filterEventoPresence').value;
            if (!eventoId || eventoId === 'all') {
                mostrarMensagem('Selecione um evento espec√≠fico antes de gerar a lista (ou escolha o evento na lista).', 'info');
                return;
            }
            const url = `/api/admin/relatorio/presencas?evento_id=${encodeURIComponent(eventoId)}`;
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error('Falha ao gerar lista de presen√ßas');
                const data = await res.json();
                const rows = data.presencas || [];
                if (rows.length === 0) {
                    mostrarMensagem('Nenhuma presen√ßa encontrada para os filtros selecionados', 'info');
                    return;
                }
                const csv = [];
                csv.push(['Nome', 'T√≠tulo do Evento', 'Data do Evento', 'Senha', 'Justificativa', 'Presen√ßa'].map(h => `"${h}"`).join(','));
                rows.forEach(r => {
                    const line = [
                        `"${(r.nome||'').replace(/"/g,'""')}"`,
                        `"${(r.titulo_evento||'').replace(/"/g,'""')}"`,
                        `"${formatDate(r.data_evento)}"`,
                        `"${(r.senha||'').toString().replace(/"/g,'""')}"`,
                        `"${(r.justificativa||'').toString().replace(/"/g,'""')}"`,
                        '""'
                    ].join(',');
                    csv.push(line);
                });

                const blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
                const urlBlob = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = urlBlob;
                a.download = `lista_presenca_${Date.now()}.csv`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(urlBlob);
                mostrarMensagem('Lista de presen√ßa exportada com sucesso!', 'success');
            } catch (err) {
                console.error(err);
                mostrarMensagem('Erro ao baixar lista de presen√ßa', 'error');
            }
        }

        // Gera e baixa PDF da lista de presen√ßa com linhas/colunas
        async function downloadPresencePDF() {
            const eventoId = document.getElementById('filterEventoPresence').value;
            const url = eventoId ? `/api/admin/relatorio/presencas?evento_id=${encodeURIComponent(eventoId)}` : '/api/admin/relatorio/presencas';
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error('Falha ao gerar lista de presen√ßas');
                const data = await res.json();
                const rows = data.presencas || [];
                if (rows.length === 0) {
                    mostrarMensagem('Nenhuma presen√ßa encontrada para os filtros selecionados', 'info');
                    return;
                }

                const headers = ['Nome', 'T√≠tulo do Evento', 'Data do Evento', 'Senha', 'Justificativa', 'Presen√ßa'];
                const body = rows.map(r => [r.nome || '', r.titulo_evento || '', formatDate(r.data_evento), (r.senha||''), (r.justificativa || ''), '']);

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'pt', 'a4');
                doc.setFontSize(14);
                // determine event title for header
                const sel = document.getElementById('filterEventoPresence');
                let eventoTitle = 'Todos Eventos';
                if (eventoId) {
                    const opt = sel.selectedOptions && sel.selectedOptions[0];
                    eventoTitle = (opt && opt.dataset && opt.dataset.title) ? opt.dataset.title : (rows[0] && rows[0].titulo_evento) || eventoTitle;
                }
                const headerTitle = `Lista de Presen√ßa - T.U.L.D - ${eventoTitle}`;
                doc.text(headerTitle, 40, 30);

                doc.autoTable({
                    head: [headers],
                    body: body,
                    startY: 50,
                    theme: 'grid',
                    styles: { fontSize: 10, cellPadding: 6 },
                    headStyles: { fillColor: [240,240,240], textColor: 20 },
                    columnStyles: {
                        0: { cellWidth: 140 },
                        1: { cellWidth: 120 },
                        2: { cellWidth: 80 },
                        3: { cellWidth: 50 },
                        4: { cellWidth: 120 },
                        5: { cellWidth: 60 }
                    }
                });

                doc.save(`lista_presenca_${Date.now()}.pdf`);
                mostrarMensagem('PDF de presen√ßa gerado com sucesso!', 'success');
            } catch (err) {
                console.error(err);
                mostrarMensagem('Erro ao gerar PDF de presen√ßa', 'error');
            }
        }

        function sair() {
            fetch('/api/logout', { method: 'POST' }).then(() => {
                window.location.href = '/index.html';
            });
        }
    </script>
</body>
</html>
